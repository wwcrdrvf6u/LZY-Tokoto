name: Auto Add Images to README and Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'images/**'
      - '.github/workflows/image-to-readme.yml'

permissions:
  contents: write
  pages: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Get new images and update README
        run: |
          ls
          python3 << 'EOF'
          import os,sys

          TEMPLATE = "# LZY-TOKOTO\n {}"
          IMGTPLT = "![{}]({}) \n\n {} \n----------\n"
          
          try:
              imgs = [i for i in os.listdir("./images/") if any(s in i for s in ('jpg','jpeg','png','gif'))]
              img_links = [IMGTPLT.format(i,f'./images/{i}',i) for i in imgs]
          except FileNotFoundError as e:
              raise RuntimeError(f'{os.getcwd()=}{sys.system('ls')=}') from e
              
          content = TEMPLATE.format(''.join(img_links))

          with open('README.md','w',encoding='utf8') as f:
              f.write(content)
              
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet README.md; then
            echo "没有变化，跳过提交"
          else
            git add README.md
            git commit -m "docs: 自动添加新增图片到README [skip ci]"
            git push
          fi

  deploy:
    needs: update-readme
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
